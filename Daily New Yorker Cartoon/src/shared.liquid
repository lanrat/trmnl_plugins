<style>
  .view {
    height: 100%;
    width: 100%;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
  }

  .image-container {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 10px;
    overflow: hidden;
    min-height: 0; /* Important for flex children */
  }

  .image-container img {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
    display: block;
    border-radius: 5px;
  }

  .title_bar {
    flex-shrink: 0;
    z-index: 1;
  }
</style>

<script>
  /**
 * Parses an HTML string and returns the 'src' attribute of the first <img> tag found.
 *
 * @param {string} htmlString The HTML string to parse.
 * @returns {string | null} The URL from the image's 'src' attribute, or null if no <img> tag is found.
 */
  function getImageUrlFromString(htmlString) {
    try {
      // 1. Create a new DOMParser
      const parser = new DOMParser();

      // 2. Parse the HTML string into a document
      // 'text/html' tells the parser to treat it as HTML
      const doc = parser.parseFromString(htmlString, 'text/html');

      // 3. Find the first <img> element in the parsed document
      const img = doc.querySelector('img');

      // 4. If an <img> tag is found, return its 'src' attribute.
      //    Otherwise, return null.
      if (img) {
        return img.getAttribute('src');
      } else {
        console.warn("No <img> tag found in the provided string.");
        return null;
      }
    } catch (error) {
      console.error("Error parsing HTML string:", error);
      return null;
    }
  }

  function getEmTextFromString(htmlString) {
    try {
      // 1. Create a new DOMParser
      const parser = new DOMParser();

      // 2. Parse the HTML string into a document
      // 'text/html' tells the parser to treat it as HTML
      const doc = parser.parseFromString(htmlString, 'text/html');

      // 3. Find the first <em> element in the parsed document
      const em = doc.querySelector('em');

      // 4. If an <em> tag is found, return its 'innerText' attribute.
      //    Otherwise, return null.
      if (em) {
        return em.textContent;
      } else {
        console.warn("No <em> tag found in the provided string.");
        return null;
      }
    } catch (error) {
      console.error("Error parsing HTML string:", error);
      return null;
    }
  }

  /**
   * The core function to remove blank space from an image.
   * @param {HTMLImageElement} imageObject The image element to process.
   * @returns {string} A data URL of the cropped image.
   */
  function removeImageBlanks(imageObject) {
    // Use naturalWidth/Height to get the actual image dimensions
    const imgWidth = imageObject.naturalWidth;
    const imgHeight = imageObject.naturalHeight;
    const canvas = document.createElement('canvas');
    canvas.width = imgWidth;
    canvas.height = imgHeight;
    const context = canvas.getContext('2d');
    context.drawImage(imageObject, 0, 0);
    let imageData;
    try {
      // This is the line that will throw a security error if the canvas is "tainted"
      imageData = context.getImageData(0, 0, imgWidth, imgHeight);
    } catch (e) {
      console.error("CORS Error:", e);
      return null;
    }
    const data = imageData.data;
    const getRBG = (x, y) => {
      const offset = (imgWidth * y + x) * 4;
      return {
        red: data[offset],
        green: data[offset + 1],
        blue: data[offset + 2],
        opacity: data[offset + 3]
      };
    };
    const isWhite = (rgb) => {
      // Check for transparent pixels first, then for "white-ish" pixels.
      return rgb.opacity < 10 || (rgb.red > 220 && rgb.green > 220 && rgb.blue > 220);
    };
    const scanY = (fromTop) => {
      const offset = fromTop ? 1 : -1;
      for (let y = fromTop ? 0 : imgHeight - 1; fromTop ? y < imgHeight : y > -1; y += offset) {
        for (let x = 0; x < imgWidth; x++) {
          if (!isWhite(getRBG(x, y))) return y;
        }
      }
      return null;
    };
    const scanX = (fromLeft) => {
      const offset = fromLeft ? 1 : -1;
      for (let x = fromLeft ? 0 : imgWidth - 1; fromLeft ? x < imgWidth : x > -1; x += offset) {
        for (let y = 0; y < imgHeight; y++) {
          if (!isWhite(getRBG(x, y))) return x;
        }
      }
      return null;
    };
    const cropTop = scanY(true);
    if (cropTop === null) {
      return imageObject.src; // Return original if blank
    }
    const cropBottom = scanY(false);
    const cropLeft = scanX(true);
    const cropRight = scanX(false);
    const cropWidth = cropRight - cropLeft + 1;
    const cropHeight = cropBottom - cropTop + 1;
    const cropCanvas = document.createElement('canvas');
    cropCanvas.width = cropWidth;
    cropCanvas.height = cropHeight;
    const cropContext = cropCanvas.getContext('2d');
    cropContext.drawImage(imageObject,
                          cropLeft, cropTop, cropWidth, cropHeight,
                          0, 0, cropWidth, cropHeight);
    return cropCanvas.toDataURL();
  }

  function displayImg(htmlString) {
    const corsProxy = 'https://cors-anywhere.com/';
    const imgElement = document.getElementById('comic');
    const txtElement = document.getElementById('caption');
    const newUrl = getImageUrlFromString(htmlString);
    if (newUrl) {
      // // set onload to crop the image once its retrieved
      // imgElement.onload = function() {
      //   // prevent infinite recursion
      //   imgElement.onload = null;
      //   // update the image to the cropped version
      //   const img_data = removeImageBlanks(imgElement);
      //   imgElement.src = img_data;
      // }
      
      // imgElement.crossOrigon = "anonymous";
      // imgElement.src = `${corsProxy}${newUrl}`;

      imgElement.src = newUrl;
      txtElement.innerText =  getEmTextFromString(htmlString); 
    } else {
      imgElement.alt = "Could not load comic.";
      console.error("Could not extract image URL.");
    }
  }


</script>

{% template comic %}
<div class="view bg-white">
  <div class="image-container">
    {% if rss.channel.item %}
    <img id="comic" class="image image-dither image--dither"/>
    {% else %}
    <p class="text--black">Error Loading Image</p>
    {% endif %}
  </div>
  <div class="caption-container">
    <p id="caption" class="value value--xsmall caption text--center" data-pixel-perfect="true" data-content-limiter="true"></p>
  </div>
  {% if rss.channel.item %}
  <script>displayImg({{ rss.channel.item[0]description | json }});</script>
  {% endif %}
</div>
{% endtemplate %}